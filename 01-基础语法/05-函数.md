# 05-å‡½æ•°

[â† è¿”å›æœ¬ç« ç›®å½•](./README.md) | [â† è¿”å›æ€»ç›®å½•](../README.md)

---

## ğŸ“‹ ç›®å½•

- [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
- [å‡½æ•°å®šä¹‰](#å‡½æ•°å®šä¹‰)
- [å‚æ•°ä¼ é€’](#å‚æ•°ä¼ é€’)
- [è¿”å›å€¼](#è¿”å›å€¼)
- [åŒ¿åå‡½æ•°](#åŒ¿åå‡½æ•°)
- [é—­åŒ…](#é—­åŒ…)
- [æ–¹æ³•](#æ–¹æ³•)
- [å‡½æ•°ç±»å‹](#å‡½æ•°ç±»å‹)
- [ä»£ç ç¤ºä¾‹](#ä»£ç ç¤ºä¾‹)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
- [é¢è¯•é¢˜](#é¢è¯•é¢˜)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [å‚è€ƒèµ„æ–™](#å‚è€ƒèµ„æ–™)

---

## æ ¸å¿ƒæ¦‚å¿µ

Go è¯­è¨€ä¸­çš„å‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘ï¼ˆFirst-class Citizenï¼‰ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹:

```
1. å‡½æ•°å¯ä»¥ä½œä¸ºå˜é‡
2. å‡½æ•°å¯ä»¥ä½œä¸ºå‚æ•°
3. å‡½æ•°å¯ä»¥ä½œä¸ºè¿”å›å€¼
4. æ”¯æŒå¤šè¿”å›å€¼
5. æ”¯æŒå‘½åè¿”å›å€¼
6. æ”¯æŒå¯å˜å‚æ•°
7. æ”¯æŒåŒ¿åå‡½æ•°å’Œé—­åŒ…
```

### å‡½æ•°ç‰¹ç‚¹

- **å€¼ä¼ é€’**ï¼šGo ä¸­æ‰€æœ‰å‚æ•°éƒ½æ˜¯å€¼ä¼ é€’
- **å¤šè¿”å›å€¼**ï¼šå¯ä»¥è¿”å›å¤šä¸ªå€¼
- **defer**ï¼šå»¶è¿Ÿæ‰§è¡Œ
- **æ²¡æœ‰å‡½æ•°é‡è½½**ï¼šä¸æ”¯æŒåŒåä¸åŒå‚æ•°çš„å‡½æ•°

---

## å‡½æ•°å®šä¹‰

### 1. åŸºæœ¬å‡½æ•°

```go
package main

import "fmt"

// æ— å‚æ•°æ— è¿”å›å€¼
func sayHello() {
    fmt.Println("Hello, World!")
}

// æœ‰å‚æ•°æ— è¿”å›å€¼
func greet(name string) {
    fmt.Println("Hello,", name)
}

// æœ‰å‚æ•°æœ‰è¿”å›å€¼
func add(a int, b int) int {
    return a + b
}

// ç›¸åŒç±»å‹å‚æ•°ç®€å†™
func multiply(a, b int) int {
    return a * b
}

func main() {
    sayHello()
    greet("Alice")
    fmt.Println("3 + 5 =", add(3, 5))
    fmt.Println("3 * 5 =", multiply(3, 5))
}
```

### 2. å¤šè¿”å›å€¼

```go
package main

import "fmt"

// è¿”å›å¤šä¸ªå€¼
func divide(a, b float64) (float64, error) {
    if b == 0 {
        return 0, fmt.Errorf("é™¤æ•°ä¸èƒ½ä¸º0")
    }
    return a / b, nil
}

// å‘½åè¿”å›å€¼
func swap(a, b int) (x, y int) {
    x = b
    y = a
    return  // è£¸è¿”å›
}

func main() {
    // æ¥æ”¶å¤šä¸ªè¿”å›å€¼
    result, err := divide(10, 2)
    if err != nil {
        fmt.Println("é”™è¯¯:", err)
    } else {
        fmt.Println("ç»“æœ:", result)
    }
    
    // å¿½ç•¥æŸä¸ªè¿”å›å€¼
    result2, _ := divide(10, 0)
    fmt.Println("ç»“æœ:", result2)
    
    // å‘½åè¿”å›å€¼
    x, y := swap(1, 2)
    fmt.Printf("äº¤æ¢å: x=%d, y=%d\n", x, y)
}
```

### 3. å¯å˜å‚æ•°

```go
package main

import "fmt"

// å¯å˜å‚æ•°ï¼ˆå¿…é¡»æ˜¯æœ€åä¸€ä¸ªå‚æ•°ï¼‰
func sum(nums ...int) int {
    total := 0
    for _, num := range nums {
        total += num
    }
    return total
}

// æ··åˆå‚æ•°
func printf(format string, args ...interface{}) {
    fmt.Printf(format, args...)
}

func main() {
    fmt.Println(sum())           // 0
    fmt.Println(sum(1))          // 1
    fmt.Println(sum(1, 2, 3))    // 6
    
    // ä¼ é€’åˆ‡ç‰‡
    nums := []int{1, 2, 3, 4, 5}
    fmt.Println(sum(nums...))    // 15
    
    printf("Name: %s, Age: %d\n", "Alice", 25)
}
```

---

## å‚æ•°ä¼ é€’

### å‚æ•°ä¼ é€’æœºåˆ¶è¯´æ˜

Go è¯­è¨€ä¸­**æ‰€æœ‰å‚æ•°éƒ½æ˜¯å€¼ä¼ é€’**ï¼Œä½†ä¸åŒç±»å‹çš„è¡Œä¸ºè¡¨ç°ä¸åŒï¼š

**å€¼ç±»å‹ï¼ˆå¤åˆ¶æ•´ä¸ªå€¼ï¼‰ï¼š**
- åŸºæœ¬ç±»å‹ï¼šintã€floatã€boolã€string
- æ•°ç»„ï¼š[n]T
- ç»“æ„ä½“ï¼šstruct

**å¼•ç”¨ç±»å‹ï¼ˆå¤åˆ¶å¼•ç”¨ï¼Œå…±äº«åº•å±‚æ•°æ®ï¼‰ï¼š**
- åˆ‡ç‰‡ï¼š[]Tï¼ˆå¤åˆ¶åˆ‡ç‰‡å¤´ï¼Œå…±äº«åº•å±‚æ•°ç»„ï¼‰
- Mapï¼šmap[K]Vï¼ˆå¤åˆ¶ map æŒ‡é’ˆï¼Œå…±äº«åº•å±‚å“ˆå¸Œè¡¨ï¼‰
- Channelï¼šchan Tï¼ˆå¤åˆ¶ channel æŒ‡é’ˆï¼Œå…±äº«åº•å±‚é˜Ÿåˆ—ï¼‰
- æ¥å£ï¼šinterface{}ï¼ˆå¤åˆ¶æ¥å£å€¼ï¼ŒåŒ…å«ç±»å‹å’Œæ•°æ®æŒ‡é’ˆï¼‰
- å‡½æ•°ï¼šfuncï¼ˆå¤åˆ¶å‡½æ•°æŒ‡é’ˆï¼‰

**æŒ‡é’ˆç±»å‹ï¼š**
- æŒ‡é’ˆï¼š*Tï¼ˆå¤åˆ¶æŒ‡é’ˆå€¼ï¼ŒæŒ‡å‘åŒä¸€åœ°å€ï¼‰

### 1. å€¼ç±»å‹ä¼ é€’

```go
package main

import "fmt"

// åŸºæœ¬ç±»å‹
func modifyInt(x int) {
    x = 100
    fmt.Println("å‡½æ•°å†…:", x)
}

// æ•°ç»„
func modifyArray(arr [3]int) {
    arr[0] = 100
    fmt.Println("å‡½æ•°å†…:", arr)
}

// ç»“æ„ä½“
type Person struct {
    Name string
    Age  int
}

func modifyStruct(p Person) {
    p.Age = 30
    fmt.Println("å‡½æ•°å†…:", p)
}

func main() {
    // åŸºæœ¬ç±»å‹
    a := 10
    modifyInt(a)
    fmt.Println("å‡½æ•°å¤–:", a)  // 10 (æœªæ”¹å˜)
    
    // æ•°ç»„
    arr := [3]int{1, 2, 3}
    modifyArray(arr)
    fmt.Println("å‡½æ•°å¤–:", arr)  // [1 2 3] (æœªæ”¹å˜)
    
    // ç»“æ„ä½“
    person := Person{"Alice", 25}
    modifyStruct(person)
    fmt.Println("å‡½æ•°å¤–:", person)  // {Alice 25} (æœªæ”¹å˜)
}
```

### 2. æŒ‡é’ˆä¼ é€’

```go
package main

import "fmt"

func modifyPointer(p *int) {
    *p = 100
    fmt.Println("å‡½æ•°å†…:", *p)
}

func modifyStructPointer(p *Person) {
    p.Age = 30
    fmt.Println("å‡½æ•°å†…:", p)
}

type Person struct {
    Name string
    Age  int
}

func main() {
    // åŸºæœ¬ç±»å‹æŒ‡é’ˆ
    a := 10
    modifyPointer(&a)
    fmt.Println("å‡½æ•°å¤–:", a)  // 100 (å·²æ”¹å˜)
    
    // ç»“æ„ä½“æŒ‡é’ˆ
    person := &Person{"Alice", 25}
    modifyStructPointer(person)
    fmt.Println("å‡½æ•°å¤–:", person)  // &{Alice 30} (å·²æ”¹å˜)
}
```

### 3. å¼•ç”¨ç±»å‹ä¼ é€’ï¼ˆåˆ‡ç‰‡ï¼‰

```go
package main

import "fmt"

// ä¿®æ”¹åˆ‡ç‰‡å…ƒç´ ï¼ˆä¼šå½±å“åŸåˆ‡ç‰‡ï¼‰
func modifySlice(s []int) {
    s[0] = 100
    fmt.Println("å‡½æ•°å†…:", s)
}

// append æ“ä½œï¼ˆå¯èƒ½ä¸å½±å“åŸåˆ‡ç‰‡ï¼‰
func appendSlice(s []int) {
    s = append(s, 4)
    fmt.Println("å‡½æ•°å†…:", s)
}

// æ­£ç¡®çš„ append æ–¹å¼
func appendSliceCorrect(s []int) []int {
    s = append(s, 4)
    return s
}

// ä½¿ç”¨æŒ‡é’ˆä¼ é€’åˆ‡ç‰‡ï¼ˆä¸æ¨èï¼‰
func appendSlicePointer(s *[]int) {
    *s = append(*s, 4)
}

func main() {
    slice := []int{1, 2, 3}
    
    // ä¿®æ”¹å…ƒç´ ï¼ˆä¼šå½±å“åŸåˆ‡ç‰‡ï¼Œå› ä¸ºå…±äº«åº•å±‚æ•°ç»„ï¼‰
    modifySlice(slice)
    fmt.Println("å‡½æ•°å¤–:", slice)  // [100 2 3]
    
    // appendï¼ˆä¸ä¼šå½±å“åŸåˆ‡ç‰‡ï¼Œå› ä¸ºå¯èƒ½è§¦å‘æ‰©å®¹ï¼‰
    appendSlice(slice)
    fmt.Println("å‡½æ•°å¤–:", slice)  // [100 2 3]
    
    // æ­£ç¡®çš„ append æ–¹å¼
    slice = appendSliceCorrect(slice)
    fmt.Println("å‡½æ•°å¤–:", slice)  // [100 2 3 4]
    
    // ä½¿ç”¨æŒ‡é’ˆä¼ é€’åˆ‡ç‰‡
    appendSlicePointer(&slice)
    fmt.Println("å‡½æ•°å¤–:", slice)  // [100 2 3 4 4]
}
```

**åˆ‡ç‰‡ä¼ é€’åŸç†ï¼š**
```
åˆ‡ç‰‡ç»“æ„ï¼š
type slice struct {
    array unsafe.Pointer  // æŒ‡å‘åº•å±‚æ•°ç»„
    len   int             // é•¿åº¦
    cap   int             // å®¹é‡
}

ä¼ é€’åˆ‡ç‰‡æ—¶ï¼š
1. å¤åˆ¶åˆ‡ç‰‡å¤´ï¼ˆ24å­—èŠ‚ï¼šæŒ‡é’ˆ8å­—èŠ‚ + len8å­—èŠ‚ + cap8å­—èŠ‚ï¼‰
2. ä¸å¤åˆ¶åº•å±‚æ•°ç»„
3. ä¿®æ”¹å…ƒç´ ä¼šå½±å“åŸåˆ‡ç‰‡ï¼ˆå…±äº«åº•å±‚æ•°ç»„ï¼‰
4. append å¯èƒ½è§¦å‘æ‰©å®¹ï¼Œåˆ›å»ºæ–°æ•°ç»„ï¼Œä¸å½±å“åŸåˆ‡ç‰‡
```

### 4. å¼•ç”¨ç±»å‹ä¼ é€’ï¼ˆMapï¼‰

```go
package main

import "fmt"

// ä¿®æ”¹ Mapï¼ˆä¼šå½±å“åŸ Mapï¼‰
func modifyMap(m map[string]int) {
    m["age"] = 30
    m["score"] = 100
}

// é‡æ–°èµ‹å€¼ Mapï¼ˆä¸ä¼šå½±å“åŸ Mapï¼‰
func reassignMap(m map[string]int) {
    m = make(map[string]int)
    m["new"] = 999
    fmt.Println("å‡½æ•°å†…:", m)
}

func main() {
    person := map[string]int{"age": 25}
    
    // ä¿®æ”¹ Mapï¼ˆä¼šå½±å“åŸ Mapï¼Œå› ä¸ºå…±äº«åº•å±‚å“ˆå¸Œè¡¨ï¼‰
    modifyMap(person)
    fmt.Println("å‡½æ•°å¤–:", person)  // map[age:30 score:100]
    
    // é‡æ–°èµ‹å€¼ï¼ˆä¸ä¼šå½±å“åŸ Mapï¼‰
    reassignMap(person)
    fmt.Println("å‡½æ•°å¤–:", person)  // map[age:30 score:100]
}
```

**Map ä¼ é€’åŸç†ï¼š**
```
Map æœ¬è´¨ä¸Šæ˜¯æŒ‡å‘ hmap ç»“æ„çš„æŒ‡é’ˆ

ä¼ é€’ Map æ—¶ï¼š
1. å¤åˆ¶ Map æŒ‡é’ˆï¼ˆ8å­—èŠ‚ï¼‰
2. ä¸å¤åˆ¶åº•å±‚å“ˆå¸Œè¡¨
3. ä¿®æ”¹ Map ä¼šå½±å“åŸ Mapï¼ˆå…±äº«åº•å±‚æ•°æ®ï¼‰
4. é‡æ–°èµ‹å€¼ä¸ä¼šå½±å“åŸ Mapï¼ˆåªæ”¹å˜äº†å±€éƒ¨æŒ‡é’ˆï¼‰
```

### 5. å¼•ç”¨ç±»å‹ä¼ é€’ï¼ˆChannelï¼‰

```go
package main

import (
    "fmt"
    "time"
)

// å‘ Channel å‘é€æ•°æ®
func sendData(ch chan int) {
    ch <- 100
}

// ä» Channel æ¥æ”¶æ•°æ®
func receiveData(ch chan int) {
    data := <-ch
    fmt.Println("æ¥æ”¶åˆ°:", data)
}

func main() {
    ch := make(chan int)
    
    // Channel ä¼ é€’ï¼ˆå…±äº«åŒä¸€ä¸ª Channelï¼‰
    go sendData(ch)
    go receiveData(ch)
    
    time.Sleep(time.Second)
}
```

**Channel ä¼ é€’åŸç†ï¼š**
```
Channel æœ¬è´¨ä¸Šæ˜¯æŒ‡å‘ hchan ç»“æ„çš„æŒ‡é’ˆ

ä¼ é€’ Channel æ—¶ï¼š
1. å¤åˆ¶ Channel æŒ‡é’ˆï¼ˆ8å­—èŠ‚ï¼‰
2. ä¸å¤åˆ¶åº•å±‚é˜Ÿåˆ—
3. å¤šä¸ª goroutine å¯ä»¥å…±äº«åŒä¸€ä¸ª Channel
```

### 6. æ¥å£ç±»å‹ä¼ é€’

```go
package main

import "fmt"

type Animal interface {
    Speak() string
}

type Dog struct {
    Name string
}

func (d Dog) Speak() string {
    return "Woof!"
}

// æ¥å£ä¼ é€’
func makeSpeak(a Animal) {
    fmt.Println(a.Speak())
}

// ä¿®æ”¹æ¥å£åº•å±‚æ•°æ®ï¼ˆå€¼æ¥æ”¶è€…ï¼Œä¸ä¼šå½±å“ï¼‰
func modifyAnimal(a Animal) {
    if dog, ok := a.(Dog); ok {
        dog.Name = "Modified"
        fmt.Println("å‡½æ•°å†…:", dog.Name)
    }
}

// ä¿®æ”¹æ¥å£åº•å±‚æ•°æ®ï¼ˆæŒ‡é’ˆæ¥æ”¶è€…ï¼Œä¼šå½±å“ï¼‰
func modifyAnimalPointer(a Animal) {
    if dog, ok := a.(*Dog); ok {
        dog.Name = "Modified"
        fmt.Println("å‡½æ•°å†…:", dog.Name)
    }
}

func main() {
    dog := Dog{Name: "Buddy"}
    
    // æ¥å£ä¼ é€’
    makeSpeak(dog)
    
    // å€¼æ¥æ”¶è€…ï¼ˆä¸ä¼šå½±å“åŸå¯¹è±¡ï¼‰
    modifyAnimal(dog)
    fmt.Println("å‡½æ•°å¤–:", dog.Name)  // Buddy
    
    // æŒ‡é’ˆæ¥æ”¶è€…ï¼ˆä¼šå½±å“åŸå¯¹è±¡ï¼‰
    modifyAnimalPointer(&dog)
    fmt.Println("å‡½æ•°å¤–:", dog.Name)  // Modified
}
```

**æ¥å£ä¼ é€’åŸç†ï¼š**
```
æ¥å£ç»“æ„ï¼š
type iface struct {
    tab  *itab           // ç±»å‹ä¿¡æ¯
    data unsafe.Pointer  // æ•°æ®æŒ‡é’ˆ
}

ä¼ é€’æ¥å£æ—¶ï¼š
1. å¤åˆ¶æ¥å£å€¼ï¼ˆ16å­—èŠ‚ï¼štabæŒ‡é’ˆ8å­—èŠ‚ + dataæŒ‡é’ˆ8å­—èŠ‚ï¼‰
2. å¦‚æœåº•å±‚æ˜¯å€¼ç±»å‹ï¼Œdata æŒ‡å‘å€¼çš„å‰¯æœ¬
3. å¦‚æœåº•å±‚æ˜¯æŒ‡é’ˆç±»å‹ï¼Œdata æŒ‡å‘åŸå¯¹è±¡
```

---

## è¿”å›å€¼

### 1. æ™®é€šè¿”å›å€¼

```go
package main

import "fmt"

func getMax(a, b int) int {
    if a > b {
        return a
    }
    return b
}

func main() {
    fmt.Println(getMax(10, 20))
}
```

### 2. å‘½åè¿”å›å€¼

```go
package main

import "fmt"

func divide(a, b float64) (result float64, err error) {
    if b == 0 {
        err = fmt.Errorf("é™¤æ•°ä¸èƒ½ä¸º0")
        return  // è¿”å›é›¶å€¼å’Œé”™è¯¯
    }
    result = a / b
    return  // è£¸è¿”å›
}

func main() {
    result, err := divide(10, 2)
    if err != nil {
        fmt.Println("é”™è¯¯:", err)
    } else {
        fmt.Println("ç»“æœ:", result)
    }
}
```

### 3. å¤šè¿”å›å€¼çš„é™·é˜±

```go
package main

import "fmt"

func test() (x int) {
    defer func() {
        x++
    }()
    return 5
}

func test2() (x int) {
    x = 5
    defer func() {
        x++
    }()
    return
}

func main() {
    fmt.Println(test())   // 6
    fmt.Println(test2())  // 6
}
```

---

## åŒ¿åå‡½æ•°

### 1. åŸºæœ¬åŒ¿åå‡½æ•°

```go
package main

import "fmt"

func main() {
    // å®šä¹‰å¹¶ç«‹å³è°ƒç”¨
    func() {
        fmt.Println("åŒ¿åå‡½æ•°")
    }()
    
    // èµ‹å€¼ç»™å˜é‡
    add := func(a, b int) int {
        return a + b
    }
    fmt.Println(add(3, 5))
    
    // å¸¦å‚æ•°çš„åŒ¿åå‡½æ•°
    func(name string) {
        fmt.Println("Hello,", name)
    }("Alice")
}
```

### 2. åŒ¿åå‡½æ•°ä½œä¸ºå‚æ•°

```go
package main

import "fmt"

func apply(nums []int, fn func(int) int) []int {
    result := make([]int, len(nums))
    for i, num := range nums {
        result[i] = fn(num)
    }
    return result
}

func main() {
    nums := []int{1, 2, 3, 4, 5}
    
    // å¹³æ–¹
    squares := apply(nums, func(n int) int {
        return n * n
    })
    fmt.Println(squares)  // [1 4 9 16 25]
    
    // åŒå€
    doubles := apply(nums, func(n int) int {
        return n * 2
    })
    fmt.Println(doubles)  // [2 4 6 8 10]
}
```

### 3. åŒ¿åå‡½æ•°ä½œä¸ºè¿”å›å€¼

```go
package main

import "fmt"

func makeAdder(x int) func(int) int {
    return func(y int) int {
        return x + y
    }
}

func main() {
    add5 := makeAdder(5)
    add10 := makeAdder(10)
    
    fmt.Println(add5(3))   // 8
    fmt.Println(add10(3))  // 13
}
```

---

## é—­åŒ…

### 1. åŸºæœ¬é—­åŒ…

```go
package main

import "fmt"

func counter() func() int {
    count := 0
    return func() int {
        count++
        return count
    }
}

func main() {
    c1 := counter()
    fmt.Println(c1())  // 1
    fmt.Println(c1())  // 2
    fmt.Println(c1())  // 3
    
    c2 := counter()
    fmt.Println(c2())  // 1
    fmt.Println(c2())  // 2
}
```

### 2. é—­åŒ…é™·é˜±

```go
package main

import "fmt"

func main() {
    // é”™è¯¯ç¤ºä¾‹
    funcs := make([]func(), 5)
    for i := 0; i < 5; i++ {
        funcs[i] = func() {
            fmt.Println(i)  // æ•è·çš„æ˜¯å˜é‡å¼•ç”¨
        }
    }
    
    for _, f := range funcs {
        f()  // è¾“å‡º: 5 5 5 5 5
    }
    
    fmt.Println("---")
    
    // æ­£ç¡®ç¤ºä¾‹
    funcs2 := make([]func(), 5)
    for i := 0; i < 5; i++ {
        i := i  // åˆ›å»ºæ–°å˜é‡
        funcs2[i] = func() {
            fmt.Println(i)
        }
    }
    
    for _, f := range funcs2 {
        f()  // è¾“å‡º: 0 1 2 3 4
    }
}
```

### 3. é—­åŒ…åº”ç”¨

```go
package main

import (
    "fmt"
    "time"
)

// è®¡æ—¶å™¨
func timer(name string) func() {
    start := time.Now()
    return func() {
        fmt.Printf("%s è€—æ—¶: %v\n", name, time.Since(start))
    }
}

// ç¼“å­˜
func fibonacci() func() int {
    a, b := 0, 1
    return func() int {
        a, b = b, a+b
        return a
    }
}

func main() {
    // è®¡æ—¶å™¨
    stop := timer("æ“ä½œ")
    time.Sleep(time.Second)
    stop()
    
    // æ–æ³¢é‚£å¥‘æ•°åˆ—
    fib := fibonacci()
    for i := 0; i < 10; i++ {
        fmt.Print(fib(), " ")
    }
    fmt.Println()
}
```

---

## æ–¹æ³•

### 1. å€¼æ¥æ”¶è€…

```go
package main

import "fmt"

type Rectangle struct {
    Width, Height float64
}

// å€¼æ¥æ”¶è€…
func (r Rectangle) Area() float64 {
    return r.Width * r.Height
}

// å€¼æ¥æ”¶è€…ä¸èƒ½ä¿®æ”¹åŸå¯¹è±¡
func (r Rectangle) Scale(factor float64) {
    r.Width *= factor
    r.Height *= factor
}

func main() {
    rect := Rectangle{Width: 10, Height: 5}
    fmt.Println("é¢ç§¯:", rect.Area())
    
    rect.Scale(2)
    fmt.Println("ç¼©æ”¾å:", rect)  // æœªæ”¹å˜
}
```

### 2. æŒ‡é’ˆæ¥æ”¶è€…

```go
package main

import "fmt"

type Rectangle struct {
    Width, Height float64
}

// æŒ‡é’ˆæ¥æ”¶è€…å¯ä»¥ä¿®æ”¹åŸå¯¹è±¡
func (r *Rectangle) Scale(factor float64) {
    r.Width *= factor
    r.Height *= factor
}

func main() {
    rect := Rectangle{Width: 10, Height: 5}
    rect.Scale(2)
    fmt.Println("ç¼©æ”¾å:", rect)  // {20 10}
}
```

### 3. æ–¹æ³•å€¼å’Œæ–¹æ³•è¡¨è¾¾å¼

```go
package main

import "fmt"

type Calculator struct {
    value int
}

func (c Calculator) Add(n int) int {
    return c.value + n
}

func main() {
    calc := Calculator{value: 10}
    
    // æ–¹æ³•å€¼ï¼ˆç»‘å®šæ¥æ”¶è€…ï¼‰
    add := calc.Add
    fmt.Println(add(5))  // 15
    
    // æ–¹æ³•è¡¨è¾¾å¼ï¼ˆéœ€è¦ä¼ é€’æ¥æ”¶è€…ï¼‰
    addExpr := Calculator.Add
    fmt.Println(addExpr(calc, 5))  // 15
}
```

---

## å‡½æ•°ç±»å‹

### 1. å‡½æ•°ç±»å‹å®šä¹‰

```go
package main

import "fmt"

// å®šä¹‰å‡½æ•°ç±»å‹
type BinaryOp func(int, int) int

func add(a, b int) int {
    return a + b
}

func multiply(a, b int) int {
    return a * b
}

func apply(a, b int, op BinaryOp) int {
    return op(a, b)
}

func main() {
    fmt.Println(apply(3, 5, add))      // 8
    fmt.Println(apply(3, 5, multiply)) // 15
}
```

### 2. å‡½æ•°ä½œä¸ºç»“æ„ä½“å­—æ®µ

```go
package main

import "fmt"

type Calculator struct {
    Add      func(int, int) int
    Subtract func(int, int) int
}

func main() {
    calc := Calculator{
        Add: func(a, b int) int {
            return a + b
        },
        Subtract: func(a, b int) int {
            return a - b
        },
    }
    
    fmt.Println(calc.Add(10, 5))      // 15
    fmt.Println(calc.Subtract(10, 5)) // 5
}
```

### 3. å‡½æ•°é€‰é¡¹æ¨¡å¼

```go
package main

import "fmt"

type Server struct {
    Host string
    Port int
}

type Option func(*Server)

func WithHost(host string) Option {
    return func(s *Server) {
        s.Host = host
    }
}

func WithPort(port int) Option {
    return func(s *Server) {
        s.Port = port
    }
}

func NewServer(opts ...Option) *Server {
    server := &Server{
        Host: "localhost",
        Port: 8080,
    }
    
    for _, opt := range opts {
        opt(server)
    }
    
    return server
}

func main() {
    server := NewServer(
        WithHost("0.0.0.0"),
        WithPort(9000),
    )
    fmt.Printf("Server: %s:%d\n", server.Host, server.Port)
}
```

---

## ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹ 1: é€’å½’å‡½æ•°

```go
package main

import "fmt"

// é˜¶ä¹˜
func factorial(n int) int {
    if n <= 1 {
        return 1
    }
    return n * factorial(n-1)
}

// æ–æ³¢é‚£å¥‘æ•°åˆ—
func fibonacci(n int) int {
    if n <= 1 {
        return n
    }
    return fibonacci(n-1) + fibonacci(n-2)
}

func main() {
    fmt.Println("5! =", factorial(5))
    
    fmt.Print("æ–æ³¢é‚£å¥‘æ•°åˆ—: ")
    for i := 0; i < 10; i++ {
        fmt.Print(fibonacci(i), " ")
    }
    fmt.Println()
}
```

### ç¤ºä¾‹ 2: é«˜é˜¶å‡½æ•°

```go
package main

import "fmt"

// Map
func Map(nums []int, fn func(int) int) []int {
    result := make([]int, len(nums))
    for i, num := range nums {
        result[i] = fn(num)
    }
    return result
}

// Filter
func Filter(nums []int, fn func(int) bool) []int {
    result := []int{}
    for _, num := range nums {
        if fn(num) {
            result = append(result, num)
        }
    }
    return result
}

// Reduce
func Reduce(nums []int, init int, fn func(int, int) int) int {
    result := init
    for _, num := range nums {
        result = fn(result, num)
    }
    return result
}

func main() {
    nums := []int{1, 2, 3, 4, 5}
    
    // å¹³æ–¹
    squares := Map(nums, func(n int) int {
        return n * n
    })
    fmt.Println("å¹³æ–¹:", squares)
    
    // è¿‡æ»¤å¶æ•°
    evens := Filter(nums, func(n int) bool {
        return n%2 == 0
    })
    fmt.Println("å¶æ•°:", evens)
    
    // æ±‚å’Œ
    sum := Reduce(nums, 0, func(acc, n int) int {
        return acc + n
    })
    fmt.Println("æ±‚å’Œ:", sum)
}
```

### ç¤ºä¾‹ 3: è£…é¥°å™¨æ¨¡å¼

```go
package main

import (
    "fmt"
    "time"
)

type HandlerFunc func(string) string

// æ—¥å¿—è£…é¥°å™¨
func LogDecorator(fn HandlerFunc) HandlerFunc {
    return func(input string) string {
        fmt.Println("å¼€å§‹å¤„ç†:", input)
        result := fn(input)
        fmt.Println("å¤„ç†å®Œæˆ:", result)
        return result
    }
}

// è®¡æ—¶è£…é¥°å™¨
func TimerDecorator(fn HandlerFunc) HandlerFunc {
    return func(input string) string {
        start := time.Now()
        result := fn(input)
        fmt.Printf("è€—æ—¶: %v\n", time.Since(start))
        return result
    }
}

func process(input string) string {
    time.Sleep(100 * time.Millisecond)
    return "å¤„ç†ç»“æœ: " + input
}

func main() {
    // åº”ç”¨è£…é¥°å™¨
    handler := TimerDecorator(LogDecorator(process))
    result := handler("æµ‹è¯•æ•°æ®")
    fmt.Println(result)
}
```

---

## å¸¸è§é—®é¢˜

### 1. å‡½æ•°å‚æ•°æ˜¯å€¼ä¼ é€’è¿˜æ˜¯å¼•ç”¨ä¼ é€’ï¼Ÿ

**ç­”æ¡ˆï¼š** Go ä¸­æ‰€æœ‰å‚æ•°éƒ½æ˜¯å€¼ä¼ é€’

```go
// åŸºæœ¬ç±»å‹ï¼šå¤åˆ¶å€¼
func modify(x int) {
    x = 100  // ä¸å½±å“åŸå˜é‡
}

// æŒ‡é’ˆï¼šå¤åˆ¶æŒ‡é’ˆï¼ˆä½†æŒ‡å‘åŒä¸€åœ°å€ï¼‰
func modify(p *int) {
    *p = 100  // å½±å“åŸå˜é‡
}

// åˆ‡ç‰‡ï¼šå¤åˆ¶åˆ‡ç‰‡å¤´ï¼ˆä½†å…±äº«åº•å±‚æ•°ç»„ï¼‰
func modify(s []int) {
    s[0] = 100  // å½±å“åŸåˆ‡ç‰‡
    s = append(s, 4)  // ä¸å½±å“åŸåˆ‡ç‰‡
}
```

### 2. å‘½åè¿”å›å€¼çš„ä¼˜ç¼ºç‚¹ï¼Ÿ

**ä¼˜ç‚¹ï¼š**
- å¯ä»¥ä½œä¸ºæ–‡æ¡£
- æ”¯æŒè£¸è¿”å›
- defer å¯ä»¥ä¿®æ”¹è¿”å›å€¼

**ç¼ºç‚¹ï¼š**
- å¯èƒ½è¢«æ„å¤–ä¿®æ”¹
- è£¸è¿”å›é™ä½å¯è¯»æ€§

```go
// âœ… é€‚åˆä½¿ç”¨å‘½åè¿”å›å€¼
func divide(a, b float64) (result float64, err error) {
    if b == 0 {
        err = fmt.Errorf("é™¤æ•°ä¸èƒ½ä¸º0")
        return
    }
    result = a / b
    return
}

// âŒ ä¸é€‚åˆä½¿ç”¨å‘½åè¿”å›å€¼
func add(a, b int) (sum int) {
    return a + b  // ç›´æ¥è¿”å›æ›´æ¸…æ™°
}
```

### 3. defer çš„æ‰§è¡Œé¡ºåºï¼Ÿ

**ç­”æ¡ˆï¼š** LIFOï¼ˆåè¿›å…ˆå‡ºï¼‰

```go
func main() {
    defer fmt.Println("1")
    defer fmt.Println("2")
    defer fmt.Println("3")
    // è¾“å‡º: 3 2 1
}
```

### 4. é—­åŒ…ä¸ºä»€ä¹ˆä¼šæ•è·å˜é‡å¼•ç”¨ï¼Ÿ

```go
// é”™è¯¯ç¤ºä¾‹
for i := 0; i < 3; i++ {
    defer func() {
        fmt.Println(i)  // æ•è·çš„æ˜¯å˜é‡å¼•ç”¨
    }()
}
// è¾“å‡º: 3 3 3

// æ­£ç¡®ç¤ºä¾‹
for i := 0; i < 3; i++ {
    i := i  // åˆ›å»ºæ–°å˜é‡
    defer func() {
        fmt.Println(i)
    }()
}
// è¾“å‡º: 2 1 0
```

---

## é¢è¯•é¢˜

### 1. ä¸‹é¢ä»£ç è¾“å‡ºä»€ä¹ˆï¼Ÿ

```go
func test() (x int) {
    defer func() {
        x++
    }()
    return 5
}

func main() {
    fmt.Println(test())
}
```

**ç­”æ¡ˆï¼š** 6

**è§£æï¼š**
1. è¿”å›å€¼ x èµ‹å€¼ä¸º 5
2. æ‰§è¡Œ deferï¼Œx++
3. è¿”å› x (6)

### 2. ä¸‹é¢ä»£ç æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ

```go
func main() {
    for i := 0; i < 3; i++ {
        defer fmt.Println(i)
    }
}
```

**ç­”æ¡ˆï¼š** è¾“å‡º 2 1 0

**è§£æï¼š** defer æŒ‰ LIFO é¡ºåºæ‰§è¡Œï¼Œä¸”å‚æ•°åœ¨æ³¨å†Œæ—¶æ±‚å€¼

### 3. å€¼æ¥æ”¶è€…å’ŒæŒ‡é’ˆæ¥æ”¶è€…çš„åŒºåˆ«ï¼Ÿ

**ç­”æ¡ˆï¼š**

| ç‰¹æ€§ | å€¼æ¥æ”¶è€… | æŒ‡é’ˆæ¥æ”¶è€… |
|------|----------|------------|
| ä¿®æ”¹åŸå¯¹è±¡ | å¦ | æ˜¯ |
| å†…å­˜å¼€é”€ | å¤åˆ¶æ•´ä¸ªå¯¹è±¡ | åªå¤åˆ¶æŒ‡é’ˆ |
| nil å®‰å…¨ | æ˜¯ | å¦ |
| ä½¿ç”¨åœºæ™¯ | å°å¯¹è±¡ã€ä¸éœ€ä¿®æ”¹ | å¤§å¯¹è±¡ã€éœ€è¦ä¿®æ”¹ |

### 4. å¦‚ä½•å®ç°å‡½æ•°é‡è½½ï¼Ÿ

**ç­”æ¡ˆï¼š** Go ä¸æ”¯æŒå‡½æ•°é‡è½½ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼š

```go
// æ–¹å¼ 1: ä¸åŒå‡½æ•°å
func AddInt(a, b int) int
func AddFloat(a, b float64) float64

// æ–¹å¼ 2: å¯å˜å‚æ•°
func Add(nums ...interface{}) interface{}

// æ–¹å¼ 3: å‡½æ•°é€‰é¡¹æ¨¡å¼
func NewServer(opts ...Option) *Server
```

### 5. ä»€ä¹ˆæ˜¯å‡½æ•°é€‰é¡¹æ¨¡å¼ï¼Ÿ

**ç­”æ¡ˆï¼š** ä¸€ç§ä¼˜é›…çš„é…ç½®æ¨¡å¼

```go
type Option func(*Server)

func WithHost(host string) Option {
    return func(s *Server) {
        s.Host = host
    }
}

func NewServer(opts ...Option) *Server {
    server := &Server{/* é»˜è®¤å€¼ */}
    for _, opt := range opts {
        opt(server)
    }
    return server
}

// ä½¿ç”¨
server := NewServer(
    WithHost("0.0.0.0"),
    WithPort(9000),
)
```

---

## æœ€ä½³å®è·µ

### 1. ä¼˜å…ˆä½¿ç”¨å€¼æ¥æ”¶è€…

```go
// âœ… æ¨èï¼ˆå°å¯¹è±¡ï¼‰
func (r Rectangle) Area() float64 {
    return r.Width * r.Height
}

// âœ… æ¨èï¼ˆéœ€è¦ä¿®æ”¹ï¼‰
func (r *Rectangle) Scale(factor float64) {
    r.Width *= factor
    r.Height *= factor
}
```

### 2. ä½¿ç”¨å‘½åè¿”å›å€¼æé«˜å¯è¯»æ€§

```go
// âœ… æ¨è
func divide(a, b float64) (result float64, err error) {
    if b == 0 {
        err = fmt.Errorf("é™¤æ•°ä¸èƒ½ä¸º0")
        return
    }
    result = a / b
    return
}
```

### 3. é¿å…åœ¨å¾ªç¯ä¸­ä½¿ç”¨ defer

```go
// âŒ ä¸æ¨è
for _, file := range files {
    f, _ := os.Open(file)
    defer f.Close()  // å¾ªç¯ç»“æŸåæ‰æ‰§è¡Œ
}

// âœ… æ¨è
for _, file := range files {
    func() {
        f, _ := os.Open(file)
        defer f.Close()  // æ¯æ¬¡è¿­ä»£éƒ½æ‰§è¡Œ
        // å¤„ç†æ–‡ä»¶
    }()
}
```

### 4. ä½¿ç”¨å‡½æ•°é€‰é¡¹æ¨¡å¼

```go
// âœ… æ¨èï¼ˆçµæ´»ã€å¯æ‰©å±•ï¼‰
func NewServer(opts ...Option) *Server

// âŒ ä¸æ¨èï¼ˆå‚æ•°è¿‡å¤šï¼‰
func NewServer(host string, port int, timeout time.Duration, ...)
```

### 5. é¿å…é—­åŒ…é™·é˜±

```go
// âŒ é”™è¯¯
for i := 0; i < 3; i++ {
    go func() {
        fmt.Println(i)  // æ•è·å˜é‡å¼•ç”¨
    }()
}

// âœ… æ­£ç¡®
for i := 0; i < 3; i++ {
    i := i  // åˆ›å»ºæ–°å˜é‡
    go func() {
        fmt.Println(i)
    }()
}
```

---

## å‚è€ƒèµ„æ–™

- [x] [Go å®˜æ–¹æ–‡æ¡£ - Functions](https://go.dev/ref/spec#Function_declarations)
- [x] [Effective Go - Functions](https://go.dev/doc/effective_go#functions)
- [x] [Go by Example - Functions](https://gobyexample.com/functions)
- [x] [Go by Example - Closures](https://gobyexample.com/closures)
- [x] [å‡½æ•°é€‰é¡¹æ¨¡å¼](https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis)

---

**ä¸‹ä¸€èŠ‚ï¼š** [06-æ•°ç»„ä¸åˆ‡ç‰‡](./06-æ•°ç»„ä¸åˆ‡ç‰‡.md)
